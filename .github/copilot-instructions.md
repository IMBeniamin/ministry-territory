# Copilot instructions (ministry-territory)

## Big picture
- This is a Vite + React 19 + TypeScript app using Mantine for UI, TanStack Router for file-based routing, and MapLibre GL for the “Live map” experience.
- Entry point and app wiring lives in [src/main.tsx](../src/main.tsx): Mantine providers + React Query `QueryClientProvider` + `RouterProvider`.

## Project layout (where to look)
- Routes are file-based under [src/routes/](../src/routes/): each route exports `Route = createFileRoute('...')({ component })`.
- The router is instantiated in [src/router.tsx](../src/router.tsx) from the generated route tree.
- Map functionality is in [src/app/map/](../src/app/map/):
  - Map orchestration: [src/app/map/engine/MapEngine.ts](../src/app/map/engine/MapEngine.ts)
  - Basemap definitions: [src/app/map/config/basemaps.ts](../src/app/map/config/basemaps.ts) backed by style JSONs in [public/styles/](../public/styles/)
  - Overlays (areas/heat/markers/user location): [src/app/map/engine/overlays/](../src/app/map/engine/overlays/)

## Generated / do-not-edit
- [src/routeTree.gen.ts](../src/routeTree.gen.ts) is generated by TanStack Router; never hand-edit it.
- The [/.tanstack/](../.tanstack/) folder is generated/cache; treat as ephemeral.

## Conventions & patterns
- Module alias: import from `@/…` (see `resolve.alias` in [vite.config.ts](../vite.config.ts)).
- Routing links: use `Link` from `@tanstack/react-router` (see [src/routes/__root.tsx](../src/routes/__root.tsx)).
- Map usage pattern: UI routes own the DOM container + lifecycle, then delegate to `MapEngine` via a ref.
  - Example: [src/routes/livemap.tsx](../src/routes/livemap.tsx) initializes `MapEngine` once, then calls `setBasemap`, `setOverlays`, and `setUserLocation`.
- Overlay pattern: overlays are idempotent and keyed by `MapOverlays` (see [src/app/map/types.ts](../src/app/map/types.ts)).
  - Add a new overlay by extending `MapOverlays`, implementing an `OverlayDefinition` in overlays/, and registering it in [src/app/map/engine/overlays/index.ts](../src/app/map/engine/overlays/index.ts).

## Dev workflows (pnpm)
- Install: `pnpm install`
- Dev server: `pnpm dev`
- Typecheck + build: `pnpm build` (runs `tsc -b` then `vite build`)
- Lint: `pnpm lint` (ESLint flat config in [eslint.config.js](../eslint.config.js) + Prettier via [/.prettierrc](../.prettierrc))
- Tests: `pnpm test` / `pnpm test:ui` (Vitest)
- E2E: `pnpm e2e` (Playwright)
